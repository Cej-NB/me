# sentinel

一个分布式系统的防御系统。流量控制、服务熔断、服务降级



## 1、雪崩问题及其解决方案

在微服务中调用链路中某个服务出现问题，引起所有微服务不可用，这就是雪崩

解决方案：
1、超时处理，请求超过一段时间没有响应就返回错误信息，不会无休止等待
2、舱壁模式，限定每个业务能使用的线程数，避免耗尽整个服务器资源，也叫线程隔离
3、熔断降级，由断路器统计业务执行异常的比例，超过阈值则会熔断该业务，拦截访问该业务的一切服务
4、流量控制，限制业务访问的QTS，

## 2、服务保护技术对比

|              | sentinel                        | hystrix               |
| ------------ | ------------------------------- | --------------------- |
| 隔离策略     | 信号量隔离                      | 线程池隔离/信号量隔离 |
| 熔断降级策略 | 基于慢调用比例或异常比例        | 基于失败比率          |
| 实现指标实现 | 滑动窗口                        | 滑动窗口              |
| 限流         | 基于QPS，支持基于调用关系的限流 | 有限的支持            |
| 流量整型     | 支持慢启动、匀速排队模式        | 不支持                |
|              |                                 |                       |

-信号量隔离，不创建新的线程池，控制每个业务获取的线程数量

## 3、介绍和安装

1、引入依赖

2、配置控制台地址

```
<dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
            <version>2.2.9.RELEASE</version>
</dependency>

spring:
	cloud:
		sentinel:
			transport:
				dashboard: localhost:8080
			web-context-unify: false  #默认会整合资源到context，导致链路限流失效。需关闭
```

3、访问微服务端点，触发监控，默认springmvc所有接口都会被监控

## 4、、限流规则

簇点链路：就是项目中的调用链路，链路中每个被监控的接口都是一个资源，

### 流控模式：

-直接，统计当前资源的请求，触发阈值，对当前资源直接限流，默认模式
-关联，统计当前资源相关的另一个资源，另一个资源触发阈值，对当前资源限流。
-链路，统计从指定链路访问到本资源的请求，本资源触发阈值，对指定链路限流
	使用@SentinelResource("")把service方法当成一个资源，默认只把controller内方法当作资源

### 流控效果：

-快速失败，达到阈值，抛出FlowException，立即拒绝请求，默认
-warm up，预热模式，例，qps为10，预热时长5s，那会在5s内，阈值会从10/3一直到10。
-排队等待，把请求扔进一个队列里，两个请求时间间隔不能超过指定时长。
			例，设置QPS 为5，则每个请求间隔200ms，超长时间为5s，则队列中最多存25个请求，其他会被拒绝。

### 热点参数限流:

对某资源某个参数为某个值时，进行限流

只对@SentinelResource("")标注的资源有效
热点规则->新增热点限流规则

## 5、隔离和降级

通过feign去调用服务，所以sentinel通过feign去知道调用链路，实行隔离

整合Feign：

```
feign:
	sentinel:
		enabled: true #启动feign对sentinel的支持
```

编写FallbackFactory并注册 -> 注册到FeignClient

### 线程池隔离：

服务A调用服务B，启动新线程去调用，并控制线程的数量
-支持主动超时和异步调用
-开销大

### 信号量隔离: 

服务A调用服务B，通过一个计数器，控制调用B的次数 

## 6、熔断降级

使用断路器统计服务异常比例、慢请求比例。
状态机：
-closed，
-open，失败达到阈值，转到open状态。
-half-open，熔断时间结束，尝试发一次请求，成功恢复到closed

熔断策略：
-慢调用，响应时间超过设置时间，{最大RT：50，比例阀值：0.4，熔断时长：5}
-异常比例，请求发生异常的比例
-异常数，按次数统计

## 7、授权规则

## 8、规则持久化